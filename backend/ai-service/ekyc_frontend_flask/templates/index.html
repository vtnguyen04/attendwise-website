<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-KYC Demo - Hoàn chỉnh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .card { margin-bottom: 1.5rem; }
        .card-header { font-weight: bold; background-color: #e9ecef;}
        .alert { margin-top: 1rem; }
        .result-box {
            background-color: #212529; color: #f8f9fa; padding: 15px;
            border-radius: 5px; white-space: pre-wrap; word-wrap: break-word;
            max-height: 500px; overflow-y: auto; font-family: monospace;
        }
        #webcam {
            width: 100%; max-width: 500px; height: auto;
            border-radius: 8px; border: 1px solid #ccc;
            transform: scaleX(-1); /* Lật camera để giống như gương soi */
        }
        .table th { width: 30%; }
        .challenge-container { text-align: center; }
        #instruction-text {
            font-size: 1.5rem; font-weight: bold; color: #0d6efd;
            min-height: 50px;
            transition: color 0.3s ease-in-out;
        }
        #feedback-box { font-size: 1.1rem; margin-top: 10px; min-height: 30px;}
        .spinner-border { vertical-align: middle; }
        .status-APPROVED { color: #198754; font-weight: bold; }
        .status-REJECTED { color: #dc3545; font-weight: bold; }
        .status-MANUAL_REVIEW { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Quy trình E-KYC</h1>
            <a href="/reset" class="btn btn-secondary">Bắt đầu lại</a>
        </div>

        <!-- Vùng hiển thị các thông báo (lỗi, thành công, cảnh báo) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Nếu chưa có session, hiển thị màn hình bắt đầu -->
        {% if not kyc_session.session_id %}
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Chào mừng!</h5>
                <p class="card-text">Bắt đầu quy trình xác thực danh tính điện tử.</p>
                <form action="{{ url_for('start_kyc') }}" method="post">
                    <button type="submit" class="btn btn-primary btn-lg">Bắt đầu E-KYC</button>
                </form>
            </div>
        </div>
        
        <!-- Nếu đã có session, hiển thị các bước của quy trình -->
        {% else %}
        <div class="card">
            <div class="card-header">Thông tin phiên</div>
            <div class="card-body">
                <p><strong>Session ID:</strong> {{ kyc_session.session_id }}</p>
                <p><strong>Trạng thái:</strong> <span class="badge bg-info">{{ kyc_session.status }}</span></p>
            </div>
        </div>

        <!-- Màn hình Xác nhận thông tin Mặt trước -->
        {% if kyc_session.confirming_step == 'front' %}
        <div class="card border-primary">
            <div class="card-header text-primary">Bước 1: Vui lòng xác nhận thông tin mặt trước</div>
            <div class="card-body">
                <img src="{{ url_for('get_session_image', side='front') }}" class="img-fluid rounded border mb-3" alt="Ảnh mặt trước CCCD">
                <table class="table table-bordered table-striped">
                    <tbody>
                        {% for key, value in kyc_session.data.front_id_data.items() %}
                        <tr><th>{{ key | title | replace('_', ' ') }}</th><td>{{ value }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="d-flex justify-content-end gap-2 mt-3">
                    <form action="{{ url_for('retry_step', side='front') }}" method="post"><button type="submit" class="btn btn-warning">Sai thông tin, Thử lại</button></form>
                    <form action="{{ url_for('confirm_step', side='front') }}" method="post"><button type="submit" class="btn btn-success">Thông tin chính xác</button></form>
                </div>
            </div>
        </div>

        <!-- Màn hình Upload Mặt trước -->
        {% elif kyc_session.status == 'AWAITING_FRONT_ID' %}
        <div class="card">
            <div class="card-header">Bước 1: Tải lên mặt trước CCCD</div>
            <div class="card-body">
                <form action="{{ url_for('upload_id_card', side='front') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3"><input type="file" class="form-control" name="front_image" required accept="image/*"></div>
                    <button type="submit" class="btn btn-primary">Tải lên và Trích xuất thông tin</button>
                </form>
            </div>
        </div>

        <!-- Màn hình Xác nhận thông tin Mặt sau -->
        {% elif kyc_session.confirming_step == 'back' %}
         <div class="card border-primary">
            <div class="card-header text-primary">Bước 2: Vui lòng xác nhận thông tin mặt sau</div>
            <div class="card-body">
                <img src="{{ url_for('get_session_image', side='back') }}" class="img-fluid rounded border mb-3" alt="Ảnh mặt sau CCCD">
                <table class="table table-bordered table-striped">
                     <tbody>
                        {% for key, value in kyc_session.data.back_id_data.items() %}
                        <tr><th>{{ key | title | replace('_', ' ') }}</th><td>{{ value }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="d-flex justify-content-end gap-2 mt-3">
                    <form action="{{ url_for('retry_step', side='back') }}" method="post"><button type="submit" class="btn btn-warning">Sai thông tin, Thử lại</button></form>
                    <form action="{{ url_for('confirm_step', side='back') }}" method="post"><button type="submit" class="btn btn-success">Thông tin chính xác</button></form>
                </div>
            </div>
        </div>

        <!-- Màn hình Upload Mặt sau -->
        {% elif kyc_session.status == 'AWAITING_BACK_ID' %}
        <div class="card">
            <div class="card-header">Bước 2: Tải lên mặt sau CCCD</div>
            <div class="card-body">
                <form action="{{ url_for('upload_id_card', side='back') }}" method="post" enctype="multipart/form-data">
                     <div class="mb-3"><input type="file" class="form-control" name="back_image" required accept="image/*"></div>
                     <button type="submit" class="btn btn-primary">Tải lên và Trích xuất thông tin</button>
                </form>
            </div>
        </div>

        <!-- Màn hình Chụp Selfie (Passive Liveness) -->
        {% elif kyc_session.status == 'AWAITING_SELFIE' %}
        <div class="card" id="passive-liveness-card">
            <div class="card-header">Bước 3: Chụp ảnh Selfie (Kiểm tra Liveness)</div>
            <div class="card-body">
                <p>Vui lòng nhìn thẳng vào camera và nhấn nút "Chụp ảnh".</p>
                <div id="webcam-container" class="mb-3 text-center">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="canvas" class="d-none"></canvas>
                </div>
                <div class="text-center">
                    <button id="start-camera-btn" class="btn btn-secondary">Mở Camera</button>
                    <button id="capture-btn" class="btn btn-primary" disabled>Chụp ảnh</button>
                </div>
                <form id="selfie-form" action="{{ url_for('upload_selfie') }}" method="post" class="d-none">
                    <input type="hidden" name="selfie_image_data" id="selfie_image_data">
                </form>
            </div>
        </div>

        <!-- Màn hình Thử thách Tương tác (Active Liveness) -->
        {% elif kyc_session.status == 'AWAITING_ACTIVE_LIVENESS' %}
        <div id="active-liveness-card" class="card">
            <div class="card-header">Bước 4: Thử thách Tương tác</div>
            <div class="card-body challenge-container">
                <div id="instruction-text">Đang khởi tạo thử thách...</div>
                <div id="webcam-container" class="my-3">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="canvas" class="d-none"></canvas>
                </div>
                <div id="feedback-box"></div>
                <button id="start-challenge-btn" class="btn btn-primary btn-lg">Bắt đầu Thử thách</button>
            </div>
        </div>
        
        <!-- Màn hình Kích hoạt Xác thực Cuối cùng -->
        {% elif kyc_session.status == 'ACTIVE_LIVENESS_PASSED' %}
        <div class="card">
            <div class="card-header">Bước 5: Xác thực cuối cùng</div>
            <div class="card-body text-center">
                <p class="fs-5">Tất cả dữ liệu đã được thu thập và kiểm tra liveness thành công!</p>
                <p>Nhấn nút bên dưới để thực hiện bước quan trọng nhất: so sánh khuôn mặt của bạn với khuôn mặt trên CCCD.</p>
                <form action="{{ url_for('verify_final') }}" method="post">
                    <button type="submit" class="btn btn-success btn-lg mt-2">So sánh khuôn mặt & Hoàn tất KYC</button>
                </form>
            </div>
        </div>
        
        {% endif %}

        <!-- Vùng hiển thị Kết quả cuối cùng -->
        {% if kyc_session.final_result %}
        <div class="card">
            <div class="card-header">
                Kết quả cuối cùng: 
                <span class="status-{{ (kyc_session.final_result.get('final_status') or kyc_session.final_result.get('status')) | upper }}">
                    {{ kyc_session.final_result.get('final_status') or kyc_session.final_result.get('status') }}
                </span>
            </div>
            <div class="card-body">
                <div class="result-box">
                    <pre>{{ kyc_session.final_result | tojson(indent=4) }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Logic cho Passive Liveness (chụp 1 ảnh) ---
    const passiveLivenessCard = document.getElementById("passive-liveness-card");
    if (passiveLivenessCard) {
        const video = passiveLivenessCard.querySelector("#webcam");
        const canvas = passiveLivenessCard.querySelector("#canvas");
        const startCameraBtn = passiveLivenessCard.querySelector('#start-camera-btn');
        const captureBtn = passiveLivenessCard.querySelector('#capture-btn');
        const selfieForm = passiveLivenessCard.querySelector('#selfie-form');
        const selfieImageDataInput = passiveLivenessCard.querySelector('#selfie_image_data');
        startCameraBtn.addEventListener('click', async () => { try { const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false }); video.srcObject = stream; startCameraBtn.style.display = 'none'; captureBtn.disabled = false; } catch (err) { alert("Không thể truy cập camera."); } });
        captureBtn.addEventListener('click', () => { canvas.width = video.videoWidth; canvas.height = video.videoHeight; const context = canvas.getContext('2d'); context.translate(canvas.width, 0); context.scale(-1, 1); context.drawImage(video, 0, 0, canvas.width, canvas.height); selfieImageDataInput.value = canvas.toDataURL('image/jpeg'); const stream = video.srcObject; if (stream) { stream.getTracks().forEach(track => track.stop()); } video.srcObject = null; selfieForm.submit(); });
    }

    // --- Logic cho Active Liveness Challenge ---
    const activeLivenessCard = document.getElementById("active-liveness-card");
    if (activeLivenessCard) {
        const video = activeLivenessCard.querySelector("#webcam");
        const canvas = activeLivenessCard.querySelector("#canvas");
        const startBtn = activeLivenessCard.querySelector("#start-challenge-btn");
        const instructionText = activeLivenessCard.querySelector("#instruction-text");
        const feedbackBox = activeLivenessCard.querySelector("#feedback-box");
        const kycSessionId = "{{ kyc_session.session_id }}";
        const faceServiceURL = "http://127.0.0.1:8001";
        let frameSenderInterval = null;

        const stopChallenge = () => {
            if (frameSenderInterval) clearInterval(frameSenderInterval);
            const stream = video.srcObject;
            if (stream) stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        };

        startBtn.addEventListener("click", async () => {
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Bắt đầu...';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
            } catch (err) {
                instructionText.textContent = "Lỗi không thể mở camera!"; instructionText.className = "text-danger"; return;
            }

            try {
                const response = await fetch(`${faceServiceURL}/liveness/start-challenge`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ session_id: kycSessionId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Lỗi không xác định');
                
                instructionText.textContent = data.instruction;
                startBtn.style.display = 'none';

                frameSenderInterval = setInterval(() => {
                    if (!video.srcObject) return; // Dừng nếu camera đã tắt
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.translate(canvas.width, 0); context.scale(-1, 1);
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(async (blob) => {
                        if (!blob) return;
                        const formData = new FormData();
                        formData.append('image_file', blob, 'frame.jpg');

                        try {
                            const frameResponse = await fetch(`${faceServiceURL}/liveness/submit-frame/${kycSessionId}`, { method: 'POST', body: formData });
                            const result = await frameResponse.json();

                            if (result.status === "in_progress") {
                                instructionText.textContent = result.instruction;
                                feedbackBox.textContent = "Đang chờ bạn thực hiện...";
                                feedbackBox.className = "text-secondary";
                            } else if (result.status === "success") {
                                stopChallenge();
                                feedbackBox.textContent = "Thành công! Đang chuyển sang bước cuối...";
                                feedbackBox.className = "text-success fw-bold";
                                fetch("{{ url_for('confirm_active_liveness_success') }}", { method: 'POST' })
                                    .then(response => { if (response.ok) { window.location.reload(); } else { throw new Error("Lỗi cập nhật trạng thái"); }});
                            } else if (result.status === "failed") {
                                stopChallenge();
                                instructionText.textContent = "Thử thách thất bại!";
                                feedbackBox.textContent = `Lý do: ${result.reason}`;
                                feedbackBox.className = "text-danger fw-bold";
                            }
                        } catch (err) { stopChallenge(); feedbackBox.textContent = `Lỗi hệ thống: ${err.message}`; feedbackBox.className = "text-danger fw-bold"; }
                    }, 'image/jpeg');
                }, 1200); // Gửi 1 frame mỗi 1.2 giây để giảm tải

            } catch (err) { stopChallenge(); instructionText.textContent = `Lỗi khi bắt đầu thử thách: ${err.message}`; instructionText.className = "text-danger"; }
        });
    }
});
</script>
</body>
</html>